<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hi Jess</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .fade-out { opacity: 0; transform: scale(0.5); transition: all 1.2s ease; }
        #secondMsg, #formSection { opacity: 0; transform: scale(0.8); transition: all 1s ease; }
        .fade-in { opacity: 1 !important; transform: scale(1) !important; }
    </style>
</head>

<body class="bg-black text-white min-h-screen flex items-center justify-center">

<div class="text-center">

    <h1 id="hiJess" class="text-6xl font-bold mb-4 transition-all">Hi Jess</h1>

    <p id="secondMsg" class="text-xl mb-6">
        I want to make you the happiest woman in the world every day of my life.
    </p>

    <div id="formSection" class="max-w-md mx-auto">

        <label class="block mb-1 text-left">Address to deliver the flowers:</label>
        <input id="addressInput" class="w-full p-2 text-black rounded mb-4" type="text">

        <label class="block mb-1 text-left">Favorite Color?</label>
        <input id="colorInput" class="w-full p-2 text-black rounded mb-4" type="text">

        <button id="saveBtn"
                class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded text-white font-bold w-full">
            Save Information
        </button>

        <p id="statusMsg" class="text-sm mt-4"></p>
    </div>

</div>

<script>

    // ⚠️ Pegas tu token aquí pero SOLO para pruebas locales
    const TOKEN = "AQUI_TU_TOKEN";

    // Configuración
    const USER = "EliazibNicasio";
    const REPO = "jess-form-data";
    const FILE_PATH = "data/form-data.txt";

    // Animación
    window.onload = () => {
        const hiJess = document.getElementById("hiJess");
        const secondMsg = document.getElementById("secondMsg");
        const formSection = document.getElementById("formSection");

        setTimeout(() => {
            hiJess.classList.add("fade-out");
            setTimeout(() => {
                secondMsg.classList.add("fade-in");
                setTimeout(() => formSection.classList.add("fade-in"), 800);
            }, 1200);
        }, 1500);
    };

    // Obtener SHA si el archivo ya existe
    async function getSHA() {
        const url = `https://api.github.com/repos/EliazibNicasio/jess-form-data/contents/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`;

        const res = await fetch(url, {
            headers: {
                "Authorization": `token ${TOKEN}`,
                "Accept": "application/vnd.github+json"
            }
        });

        if (res.status === 404) return null;
        const json = await res.json();
        return json.sha;
    }

    // Guardar datos
    document.getElementById("saveBtn").addEventListener("click", async () => {

        const address = document.getElementById("addressInput").value.trim();
        const color = document.getElementById("colorInput").value.trim();
        const statusMsg = document.getElementById("statusMsg");

        if (!address || !color) {
            statusMsg.textContent = "Please fill all fields.";
            statusMsg.style.color = "red";
            return;
        }

        statusMsg.textContent = "Saving...";
        statusMsg.style.color = "yellow";

        try {
            const sha = await getSHA();

            const content = 
                `Address: ${address}\nFavorite Color: ${color}\nSaved: ${new Date().toLocaleString()}\n\n`;

            const encoded = btoa(unescape(encodeURIComponent(content)));

            const response = await fetch(
                `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`,
                {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${TOKEN}`,
                        "Accept": "application/vnd.github+json"
                    },
                    body: JSON.stringify({
                        message: "Form update",
                        content: encoded,
                        sha: sha ?? undefined
                    })
                }
            );

            if (!response.ok) throw new Error("GitHub rejected the request");

            statusMsg.textContent = "Saved successfully!";
            statusMsg.style.color = "lightgreen";

        } catch (err) {
            statusMsg.textContent = "Error saving.";
            statusMsg.style.color = "red";
            console.error(err);
        }

    });

</script>

</body>
</html>
